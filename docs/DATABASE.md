# Database Documentation

## Overview
Multi-database architecture combining MongoDB for document storage, Milvus for vector similarity search, and Redis for high-performance caching. Designed for scalable e-commerce analytics with optimized queries and real-time data access.

## Database Architecture

### MongoDB - Primary Data Store
Document-based database storing user journeys, interactions, and session data with flexible schema design.

**Connection Configuration:**
- Host: `localhost:27017` (development)
- Database: `funnel_analysis`
- Authentication: Username/password with admin access
- Connection pooling for concurrent access

**Performance Features:**
- Async driver for non-blocking operations
- Connection pooling with automatic management
- Index optimization for query performance
- Aggregation pipeline for complex analytics

### Milvus - Vector Database
Specialized vector database for storing and searching high-dimensional embeddings generated by ML models.

**Configuration:**
- Host: `localhost:19530`
- Vector dimensions: 128-dimensional embeddings
- Index type: IVF_FLAT for balanced performance
- Similarity metric: Cosine similarity

**Use Cases:**
- User behavior similarity search
- ML model embedding storage
- Real-time recommendation queries
- Pattern recognition and clustering

### Redis - Caching Layer
In-memory data store providing high-speed caching for frequently accessed data and real-time metrics.

**Configuration:**
- Host: `localhost:6379`
- Memory optimization for analytics workloads
- TTL-based expiration for data freshness
- Pub/sub for real-time updates

## MongoDB Schema Design

### Collections Overview

#### Users Collection
Stores user demographic and device information.

**Document Structure:**
- `_id`: ObjectId (MongoDB primary key)
- `user_id`: Integer (business identifier)
- `device`: String (desktop/mobile/tablet)
- `sex`: String (demographic information)
- `date`: DateTime (registration/first visit date)

**Indexes:**
- `user_id`: Unique index for fast user lookups
- `device`: Index for device-based analytics
- `date`: Index for time-based queries

#### Page Visits Collection  
Records individual page visits with timing and engagement metrics.

**Document Structure:**
- `_id`: ObjectId
- `user_id`: Integer (references users)
- `page_type`: String (home/search/payment/confirmation)
- `timestamp`: DateTime (visit time)
- `duration`: Integer (time spent in seconds)
- `device`: String (device type)
- `session_id`: String (session identifier)

**Indexes:**
- Compound index: `(user_id, timestamp)` for user journey queries
- Index on `page_type` for funnel analysis
- Index on `session_id` for session analytics

#### User Interactions Collection
Detailed user interactions within pages (clicks, scrolls, hovers, form inputs).

**Document Structure:**
- `_id`: ObjectId
- `user_id`: Integer
- `session_id`: String
- `page_type`: String
- `interaction_type`: String (click/scroll/hover/form)
- `element`: String (interaction target)
- `timestamp`: DateTime
- `coordinates`: Object (x, y positions)
- `value`: String (form input values)

**Indexes:**
- Compound index: `(user_id, session_id)` for session analysis
- Index on `page_type` for page-specific analytics
- Index on `interaction_type` for behavior pattern analysis

#### User Sessions Collection
Complete user sessions with conversion status and journey summary.

**Document Structure:**
- `_id`: ObjectId
- `user_id`: Integer
- `session_id`: String (unique session identifier)
- `start_time`: DateTime
- `end_time`: DateTime
- `device`: String
- `pages_visited`: Array of page types
- `total_interactions`: Integer
- `converted`: Boolean (reached confirmation page)
- `conversion_value`: Float (purchase amount if converted)

**Indexes:**
- Unique index on `session_id`
- Compound index: `(user_id, start_time)` for user history
- Index on `converted` for conversion analysis

#### Funnel Analytics Collection (Pre-computed)
Aggregated funnel metrics for improved query performance.

**Document Structure:**
- `_id`: ObjectId
- `date`: Date (analytics date)
- `device`: String
- `funnel_step`: String
- `unique_users`: Integer
- `conversion_rate`: Float
- `drop_off_rate`: Float
- `avg_time_spent`: Float

**Indexes:**
- Compound index: `(date, device, funnel_step)` for dashboard queries
- Index on `date` for time-based analytics

## Milvus Schema Design

### Collections

#### User Behavior Embeddings
Stores 128-dimensional vectors representing user behavior patterns.

**Schema:**
- `id`: Primary key (maps to user_id)
- `embedding`: 128-dimensional float vector
- `metadata`: JSON (user device, session count, etc.)

**Index Configuration:**
- Index type: IVF_FLAT
- Number of clusters (nlist): 1024
- Search parameters: nprobe = 10

#### Page Interaction Embeddings
Vectors representing page-specific interaction patterns.

**Schema:**
- `id`: Primary key (combination of user_id and page_type)
- `embedding`: 128-dimensional float vector
- `metadata`: JSON (page type, interaction count, engagement score)

**Performance Optimization:**
- Batch insertion for efficiency
- Index building after bulk data loading
- Memory mapping for large datasets

## Redis Caching Strategy

### Cache Categories

#### Metrics Cache
Stores frequently requested dashboard metrics with TTL expiration.

**Key Patterns:**
- `metrics:dashboard:{date_range}`: Daily/weekly/monthly metrics
- `metrics:funnel:{device}:{date}`: Device-specific funnel data
- `metrics:realtime`: Current real-time statistics

**TTL Settings:**
- Real-time metrics: 30 seconds
- Daily metrics: 1 hour
- Historical metrics: 24 hours

#### User Session Cache
Temporary storage for active user sessions and real-time tracking.

**Key Patterns:**
- `session:{session_id}`: Active session data
- `user:active:{user_id}`: Current user activity
- `realtime:users`: List of currently active users

**TTL Settings:**
- Active sessions: 30 minutes
- User activity: 5 minutes
- Real-time lists: 1 minute

#### Query Result Cache
Caches expensive database query results for improved response times.

**Key Patterns:**
- `query:similar_users:{user_id}`: Similar user recommendations
- `query:user_journey:{user_id}`: Complete user journey data
- `query:sentiment:{page_type}:{date}`: Sentiment analysis results

**Cache Invalidation:**
- Time-based TTL (1-24 hours depending on data freshness requirements)
- Event-based invalidation for data updates
- Manual cache refresh endpoints

## Query Optimization

### MongoDB Aggregation Pipelines

#### Funnel Analysis Pipeline
Efficient multi-stage pipeline for calculating conversion rates across funnel steps.

**Optimization Strategies:**
- Early filtering with `$match` stages
- Index usage for initial filtering
- Proper field projection to reduce data transfer
- Pipeline stage ordering for optimal performance

#### User Behavior Analysis
Complex aggregations for user journey pattern identification and behavioral clustering.

**Performance Considerations:**
- Compound indexes for multi-field queries
- Aggregation pipeline optimization
- Memory usage monitoring for large datasets
- Proper use of `$lookup` for collection joins

### Milvus Query Optimization

#### Similarity Search Performance
Optimized vector similarity queries for real-time recommendations.

**Search Parameters:**
- Top-K result limiting (typically 10-50 results)
- Search radius for similarity thresholds
- Batch queries for multiple users
- Parallel processing for concurrent requests

**Index Tuning:**
- Regular index rebuilding with fresh data
- Parameter tuning based on data distribution
- Memory allocation optimization
- Query result caching for repeated searches

## Data Management

### Data Ingestion Pipeline

#### CSV Processing
Automated pipeline for processing sample datasets and generating synthetic interactions.

**Process Flow:**
1. CSV validation and data cleaning
2. Schema mapping to MongoDB documents
3. Relationship establishment between collections
4. Synthetic data generation for realistic interactions
5. Batch insertion with error handling

#### Real-time Data Processing
Stream processing for live user interactions and real-time analytics updates.

**Components:**
- Event capture from frontend applications
- Data validation and enrichment
- Real-time aggregation updates
- Cache invalidation triggers
- WebSocket notification dispatch

### Data Backup and Recovery

#### MongoDB Backup Strategy
- Daily automated backups with retention policy
- Point-in-time recovery capabilities
- Replica set configuration for high availability
- Cross-region backup storage for disaster recovery

#### Milvus Data Protection
- Vector index backup and restoration
- Collection snapshots for version control
- Metadata backup for schema preservation
- Distributed storage for fault tolerance

### Performance Monitoring

#### Database Health Monitoring
- Connection pool utilization tracking
- Query performance metrics collection
- Index usage analysis and optimization recommendations
- Resource utilization monitoring (CPU, memory, disk)

#### Query Performance Analysis
- Slow query identification and optimization
- Aggregation pipeline performance profiling
- Index effectiveness measurement
- Cache hit/miss ratio monitoring

## Scalability Considerations

### Horizontal Scaling
- MongoDB sharding strategy for large datasets
- Milvus distributed deployment for vector scaling
- Redis cluster configuration for cache scalability
- Load balancing across database instances

### Data Partitioning
- Time-based partitioning for historical data
- User-based sharding for query distribution
- Geographic partitioning for global deployments
- Hot/cold data storage optimization

### Performance Optimization
- Connection pooling and resource management
- Query result pagination for large datasets
- Async processing for non-blocking operations
- Caching strategies for frequently accessed data